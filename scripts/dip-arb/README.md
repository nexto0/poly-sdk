# DipArb Scripts

DipArb (暴跌套利) 策略脚本，用于 Polymarket 15 分钟 UP/DOWN 市场。

## ETH 15m 市场运行原理

### 市场生命周期

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    ETH 15m Market Lifecycle                              │
│                                                                          │
│  时间线 (以 3:15-3:30 市场为例)                                           │
│                                                                          │
│  ──────┬────────────┬────────────────────────┬──────────────┬──────────  │
│        │            │                        │              │            │
│     创建           开始交易                结束交易        Resolution     │
│   (~60min前)      3:15 AM                 3:30 AM       (~5min后)       │
│        │            │                        │              │            │
│        │            │◀──── 15分钟窗口 ────▶│              │            │
│        │            │                        │              │            │
│        │         slug时间戳               endDate           │            │
│        │        1767600900                                  │            │
│        │            │                        │              │            │
│        │            │     活跃交易期间       │   等待结算   │            │
│        │            │  ✅ 可执行套利策略     │              │            │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### 市场结算规则

每个 15 分钟市场有一个 **Price to Beat**（开盘时的 Chainlink ETH/USD 价格）：

| 结算结果 | 条件 |
|---------|------|
| UP 赢 (UP=$1, DOWN=$0) | 结束时 ETH 价格 >= Price to Beat |
| DOWN 赢 (UP=$0, DOWN=$1) | 结束时 ETH 价格 < Price to Beat |

**关键点**: UP + DOWN 结算后一定 = $1

## 策略原理

### 核心逻辑

```
套利的本质：如果买入 UP + DOWN 的总成本 < $1，则无论结果如何都有利润

利润 = $1 - 总成本
利润率 = (1 - 总成本) / 总成本

例：UP @ 0.45 + DOWN @ 0.50 = 0.95 总成本
    利润 = $1 - $0.95 = $0.05 (5.26%)
```

### 两腿策略 (Leg1 + Leg2)

```
┌────────────────────────────────────────────────────────────────────────┐
│                        DipArb 两腿策略                                  │
├────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  正常状态:  UP = 0.50    DOWN = 0.50    Sum = 1.00 (无套利空间)          │
│                                                                         │
│  ══════════════════════════════════════════════════════════════════    │
│                                                                         │
│  情绪性暴跌发生:                                                         │
│                                                                         │
│  10秒内 UP: 0.50 → 0.42 (-16%)  ← 触发 Leg1 信号!                       │
│                                                                         │
│  Leg1: 买入 UP @ 0.42                                                   │
│        (暴跌买入，抄底)                                                  │
│                                                                         │
│  等待...                                                                 │
│                                                                         │
│  对侧也下跌: DOWN: 0.50 → 0.52 (或者 UP 反弹后 DOWN 下跌)                │
│                                                                         │
│  检查: 0.42 + 0.52 = 0.94 <= 0.95 (sumTarget)                           │
│        ✅ 满足条件!                                                      │
│                                                                         │
│  Leg2: 买入 DOWN @ 0.52                                                 │
│                                                                         │
│  ══════════════════════════════════════════════════════════════════    │
│                                                                         │
│  最终持仓: UP + DOWN = 0.94                                              │
│  结算收益: $1.00 - $0.94 = $0.06 (6.38% 利润)                           │
│                                                                         │
└────────────────────────────────────────────────────────────────────────┘
```

### 为什么是"瞬时"暴跌？

```
✅ 策略捕捉的是:
   - 10 秒内 5%+ 的瞬时暴跌
   - 情绪性抛售 (恐慌/误操作)
   - 大单砸盘导致的瞬间价格偏离

❌ 不捕捉:
   - 5 分钟内渐进的 15% 下跌 (趋势下行，可能继续跌)
   - 市场真实反映底层资产变化的价格移动
```

## 脚本说明

| 脚本 | 用途 |
|------|------|
| `auto-trade.ts` | 自动交易脚本，监控 + 自动执行 |
| `scan-markets.ts` | 扫描可用市场 |
| `example-basic.ts` | 基础示例，展示 API 用法 |

## 运行

```bash
# 设置私钥
export PRIVATE_KEY=0x...

# 自动交易
npx tsx scripts/dip-arb/auto-trade.ts

# 只扫描市场
npx tsx scripts/dip-arb/scan-markets.ts
```

日志会自动保存到 `/tmp/dip-arb-*.log`

## 关键参数

```typescript
{
  // 套利控制
  sumTarget: 0.95,         // 总成本 <= 0.95 才执行 Leg2 (保证 5%+ 利润)

  // 信号检测
  dipThreshold: 0.05,      // 5% 跌幅触发 Leg1
  slidingWindowMs: 10000,  // 10 秒滑动窗口 (检测瞬时暴跌)
  windowMinutes: 14,       // 14 分钟交易窗口 (避免接近结算)

  // 执行
  autoExecute: true,       // 自动执行交易
  shares: 10,              // 每次买入份数
  maxSlippage: 0.02,       // 最大滑点 2%
}
```

## 参数对照

| sumTarget | 最小利润率 | 说明 |
|-----------|-----------|------|
| 0.90 | 11.1% | 激进，机会少 |
| 0.95 | 5.26% | 平衡，推荐 |
| 0.98 | 2.04% | 保守，机会多 |
| 1.00 | 0% | 无利润 |

## Orderbook 价格说明

```
日志示例:
[10:42:04] [DipArb] Orderbook [UP]: asks=47, bestAsk=0.53
[10:42:04] [DipArb] Orderbook [DOWN]: asks=51, bestAsk=0.49

含义:
- asks=47: 卖单深度 (有 47 个价位的卖单)
- bestAsk=0.53: 最低卖价 (买入 UP 需要 $0.53)

价格关系:
- UP bestAsk + DOWN bestAsk ≈ 1.00 ~ 1.02
- 超出 1.00 的部分是市场 spread
- 当 sum < 1.00 时存在套利空间 (罕见)
```

## 自动轮换

脚本支持市场自动轮换：

1. 市场结束前 2 分钟预加载下一个市场
2. 市场结束后自动切换
3. 支持连续运行多个 15 分钟周期

```
[10:42:29] [DipArb] checkRotation: timeUntilEnd=1050s, preloadMs=120s
           ↑ 距离结束还有 17.5 分钟
```
